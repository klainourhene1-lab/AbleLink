<?php 
$storyExists = isset($story) && is_array($story) && !empty($story);
if(!$storyExists): 
?>
    <div style="text-align:center; padding:60px;">
        <p style="color:#ef4444; font-size:1.2rem;">Story introuvable</p>
        <a href="/ablelink/stories" style="color:#6366f1; text-decoration:none;">‚Üê Retour aux stories</a>
    </div>
<?php 
else: 
    $storyId = isset($story['id']) ? (int)$story['id'] : 0;
    $storyTitle = isset($story['title']) && is_string($story['title']) ? htmlspecialchars($story['title'], ENT_QUOTES, 'UTF-8') : '';
    $storyUserName = isset($story['user_name']) && is_string($story['user_name']) ? htmlspecialchars($story['user_name'], ENT_QUOTES, 'UTF-8') : 'Anonyme';
    $storyImage = isset($story['image']) && is_string($story['image']) && trim($story['image']) !== '' ? htmlspecialchars($story['image'], ENT_QUOTES, 'UTF-8') : '';
    $storyContent = isset($story['content']) && is_string($story['content']) ? htmlspecialchars($story['content'], ENT_QUOTES, 'UTF-8') : '';
    $storyCreatedAt = isset($story['created_at']) && is_string($story['created_at']) ? $story['created_at'] : date('Y-m-d H:i:s');
    $storyLikesCount = isset($story['likes_count']) ? (int)$story['likes_count'] : 0;
    $storyHasLiked = isset($story['has_liked']) && $story['has_liked'] === true ? true : false;
    $storyStatus = isset($story['status']) ? $story['status'] : 'published';
    
    $dateFormatted = 'Date inconnue';
    if(trim($storyCreatedAt) !== '') {
        $timestamp = @strtotime($storyCreatedAt);
        if($timestamp !== false && $timestamp > 0) {
            $dateFormatted = date('d F Y √† H:i', $timestamp);
        }
    }
    
    $likeColor = $storyHasLiked ? '#ef4444' : '#64748b';
    $commentsCount = 0;
    $commentsArray = array();
    if(isset($comments) && is_array($comments)) {
        $commentsCount = count($comments);
        $commentsArray = $comments;
    }
    $scheme = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on') ? 'https' : 'http';
    $host = isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : 'localhost';
    $shareUrl = $scheme . '://' . $host . "/ablelink/stories/show/" . $storyId;
    $shareText = rawurlencode("D√©couvrez la success story \"" . strip_tags($storyTitle) . "\" sur AbleLink");
?>
<div style="max-width:900px; margin:50px auto;">
    <a href="/ablelink/stories" style="color:#6366f1; text-decoration:none; margin-bottom:20px; display:inline-block;">
        ‚Üê Retour aux stories
    </a>
    
    <div style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <?php if($storyImage !== ''): ?>
            <img src="/ablelink/public/uploads/<?php echo $storyImage; ?>" 
                 alt="Story" style="width:100%; height:400px; object-fit:cover;">
        <?php endif; ?>
        
        <div style="padding:40px;">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <h1 style="font-size:2.5rem; color:#1e293b; margin:0;">
                <?php echo $storyTitle; ?>
            </h1>
                <?php if($storyStatus === 'featured'): ?>
                    <span style="background:#e0e7ff; color:#4338ca; padding:6px 12px; border-radius:999px; font-weight:600; font-size:0.9rem;">‚≠ê Story √† la une</span>
                <?php endif; ?>
            </div>
            
            <p style="color:#64748b; margin-bottom:30px;">
                Par <strong><?php echo $storyUserName; ?></strong> ‚Ä¢ 
                <?php echo $dateFormatted; ?>
            </p>
            
            <div style="font-size:1.1rem; line-height:1.8; color:#374151; white-space:pre-wrap; margin-bottom:30px;">
                <?php echo nl2br($storyContent); ?>
            </div>
            
            <div style="display:flex; gap:20px; align-items:center; padding-top:20px; border-top:1px solid #e5e7eb; flex-wrap:wrap;">
                <button onclick="likeStory(<?php echo $storyId; ?>)" 
                        class="like-btn" 
                        data-story-id="<?php echo $storyId; ?>"
                        style="background:none; border:2px solid #ef4444; color:<?php echo $likeColor; ?>; padding:10px 20px; border-radius:8px; cursor:pointer; font-size:1rem;">
                    ‚ù§Ô∏è <span class="likes-count-<?php echo $storyId; ?>"><?php echo $storyLikesCount; ?></span> J'aime
                </button>
                <a href="/ablelink/stories/edit/<?php echo $storyId; ?>" 
                   style="background:#f59e0b; color:white; padding:10px 20px; border-radius:8px; text-decoration:none; font-size:0.9rem;">
                    ‚úèÔ∏è Modifier
                </a>
                <a href="/ablelink/stories/delete/<?php echo $storyId; ?>" 
                   onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette story ? Cette action est irr√©versible.');"
                   style="background:#ef4444; color:white; padding:10px 20px; border-radius:8px; text-decoration:none; font-size:0.9rem;">
                    üóëÔ∏è Supprimer
                </a>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <span style="color:#475569; font-weight:600;">Partager :</span>
                    <a href="https://wa.me/?text=<?php echo $shareText . '%20' . rawurlencode($shareUrl); ?>" target="_blank" style="background:#25D366; color:white; padding:8px 14px; border-radius:999px; font-size:0.85rem;">WhatsApp</a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=<?php echo rawurlencode($shareUrl); ?>" target="_blank" style="background:#1877f2; color:white; padding:8px 14px; border-radius:999px; font-size:0.85rem;">Facebook</a>
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url=<?php echo rawurlencode($shareUrl); ?>" target="_blank" style="background:#0a66c2; color:white; padding:8px 14px; border-radius:999px; font-size:0.85rem;">LinkedIn</a>
                </div>
            </div>
        </div>
    </div>
    
    <div style="background:white; border-radius:12px; padding:30px; margin-top:30px; box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <h2 style="color:#1e293b; margin-bottom:20px;">Commentaires (<?php echo $commentsCount; ?>)</h2>
        
        <form action="/ablelink/stories/comment/<?php echo $storyId; ?>" method="POST" style="margin-bottom:30px;">
            <input type="text" name="user_name" placeholder="Votre nom *" required 
                   style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <textarea name="content" rows="4" placeholder="Votre commentaire *" required 
                      style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px;"></textarea>
            <button type="submit" style="background:#6366f1; color:white; padding:10px 20px; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">
                Publier le commentaire
            </button>
        </form>
        
        <div style="display:flex; flex-direction:column; gap:20px;">
            <?php if($commentsCount > 0): ?>
                <?php foreach($commentsArray as $comment): ?>
                <?php
                    $commentUserName = isset($comment['user_name']) && is_string($comment['user_name']) ? htmlspecialchars($comment['user_name'], ENT_QUOTES, 'UTF-8') : 'Anonyme';
                    $commentContent = isset($comment['content']) && is_string($comment['content']) ? htmlspecialchars($comment['content'], ENT_QUOTES, 'UTF-8') : '';
                    $commentCreatedAt = isset($comment['created_at']) && is_string($comment['created_at']) ? $comment['created_at'] : date('Y-m-d H:i:s');
                    
                    $commentDateFormatted = 'Date inconnue';
                    if(trim($commentCreatedAt) !== '') {
                        $commentTimestamp = @strtotime($commentCreatedAt);
                        if($commentTimestamp !== false && $commentTimestamp > 0) {
                            $commentDateFormatted = date('d/m/Y H:i', $commentTimestamp);
                        }
                    }
                ?>
                <div style="padding:15px; background:#f8fafc; border-radius:8px; border-left:3px solid #6366f1;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong style="color:#1e293b;"><?php echo $commentUserName; ?></strong>
                        <span style="color:#64748b; font-size:0.9rem;">
                            <?php echo $commentDateFormatted; ?>
                        </span>
                    </div>
                    <p style="color:#475569; line-height:1.6; margin:0;">
                        <?php echo nl2br($commentContent); ?>
                    </p>
                </div>
                <?php endforeach; ?>
            <?php else: ?>
                <p style="text-align:center; color:#94a3b8; padding:40px;">
                    Aucun commentaire pour le moment. Soyez le premier √† commenter !
                </p>
            <?php endif; ?>
        </div>
    </div>
</div>

<script>
function likeStory(id) {
    if(!id || id === 0) {
        alert('ID invalide');
        return;
    }
    var url = '/ablelink/stories/like/' + id;
    fetch(url, {method: 'POST'})
        .then(function(response) { 
            if(!response.ok) {
                throw new Error('Erreur r√©seau');
            }
            return response.json(); 
        })
        .then(function(data) {
            if(data && data.success) {
                var selector = '.likes-count-' + id;
                var countElement = document.querySelector(selector);
                var buttonSelector = '[data-story-id="' + id + '"]';
                var buttonElement = document.querySelector(buttonSelector);
                if(countElement) {
                    countElement.textContent = data.likes || 0;
                }
                if(buttonElement) {
                    buttonElement.style.color = '#ef4444';
                    buttonElement.style.borderColor = '#ef4444';
                }
            } else {
                var message = 'D√©j√† lik√©';
                if(data && data.message) {
                    message = data.message;
                }
                alert(message);
            }
        })
        .catch(function(error) {
            console.error('Erreur:', error);
            alert('Une erreur est survenue');
        });
}
</script>
<?php endif; ?>



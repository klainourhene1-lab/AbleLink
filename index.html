<div class="main-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h1 style="color:#6366f1; font-size:2rem;">Success Stories</h1>
        <a href="/ablelink/stories/create" style="background:#6366f1; color:white; padding:12px 25px; border-radius:8px; text-decoration:none;">
            + Partager ma story
        </a>
    </div>

    <div class="stories-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(350px, 1fr)); gap:25px;">
        <?php 
        $hasStories = isset($stories) && is_array($stories) && count($stories) > 0;
        if(!$hasStories): 
        ?>
            <p style="grid-column:1/-1; text-align:center; padding:60px; color:#94a3b8;">
                Aucune success story pour le moment. Soyez le premier √† partager !
            </p>
        <?php else: ?>
            <?php foreach($stories as $story): ?>
            <?php 
                $storyId = 0;
                if(isset($story['id'])) {
                    $storyId = (int)$story['id'];
                }
                
                $storyTitle = 'Sans titre';
                if(isset($story['title']) && is_string($story['title'])) {
                    $storyTitle = htmlspecialchars($story['title'], ENT_QUOTES, 'UTF-8');
                }
                
                $storyUserName = 'Anonyme';
                if(isset($story['user_name']) && is_string($story['user_name'])) {
                    $storyUserName = htmlspecialchars($story['user_name'], ENT_QUOTES, 'UTF-8');
                }
                
                $storyImage = '';
                if(isset($story['image']) && is_string($story['image']) && trim($story['image']) !== '') {
                    $storyImage = htmlspecialchars($story['image'], ENT_QUOTES, 'UTF-8');
                }
                
                $storyContent = '';
                if(isset($story['content']) && is_string($story['content'])) {
                    $storyContent = htmlspecialchars($story['content'], ENT_QUOTES, 'UTF-8');
                }
                
                $storyCreatedAt = date('Y-m-d H:i:s');
                if(isset($story['created_at']) && is_string($story['created_at'])) {
                    $storyCreatedAt = $story['created_at'];
                }
                
                $storyLikesCount = 0;
                if(isset($story['likes_count'])) {
                    $storyLikesCount = (int)$story['likes_count'];
                }
                
                $storyHasLiked = false;
                if(isset($story['has_liked']) && $story['has_liked'] === true) {
                    $storyHasLiked = true;
                }
                
                $contentPreview = $storyContent;
                $contentLength = strlen($storyContent);
                if($contentLength > 150) {
                    $contentPreview = substr($storyContent, 0, 150) . '...';
                }
                
                $dateFormatted = 'Date inconnue';
                if(trim($storyCreatedAt) !== '') {
                    $timestamp = @strtotime($storyCreatedAt);
                    if($timestamp !== false && $timestamp > 0) {
                        $dateFormatted = date('d/m/Y', $timestamp);
                    }
                }
                
                $likeColor = $storyHasLiked ? '#ef4444' : '#64748b';
                $storyStatus = isset($story['status']) ? $story['status'] : 'published';
                $isTopStory = isset($topStoryId) && $topStoryId > 0 && $storyId === $topStoryId;
            ?>
            <div class="story-card" style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.1); position:relative;">
                <?php if($isTopStory || $storyStatus === 'featured'): ?>
                    <div style="position:absolute; margin:15px; background:#fca5a5; color:#b91c1c; padding:6px 12px; border-radius:999px; font-weight:600; font-size:0.85rem;">
                        <?php echo $isTopStory ? 'üî• Top story' : '‚≠ê √Ä la une'; ?>
                    </div>
                <?php endif; ?>
                <?php if($storyImage !== ''): ?>
                    <img src="/ablelink/public/uploads/<?php echo $storyImage; ?>" 
                         alt="Story" style="width:100%; height:200px; object-fit:cover;">
                <?php endif; ?>
                
                <div style="padding:20px;">
                    <h3 style="color:#1e293b; margin-bottom:10px; font-size:1.3rem;">
                        <?php echo $storyTitle; ?>
                    </h3>
                    
                    <p style="color:#64748b; font-size:0.9rem; margin-bottom:10px;">
                        Par <strong><?php echo $storyUserName; ?></strong> ‚Ä¢ 
                        <?php echo $dateFormatted; ?>
                    </p>
                    
                    <p style="color:#475569; line-height:1.6; margin-bottom:15px;">
                        <?php echo $contentPreview; ?>
                    </p>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                        <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                            <button onclick="likeStory(<?php echo $storyId; ?>)" 
                                    class="like-btn" 
                                    data-story-id="<?php echo $storyId; ?>"
                                    style="background:none; border:none; cursor:pointer; color:<?php echo $likeColor; ?>; font-size:1.1rem;">
                                ‚ù§Ô∏è <span class="likes-count-<?php echo $storyId; ?>"><?php echo $storyLikesCount; ?></span>
                            </button>
                            <a href="/ablelink/stories/show/<?php echo $storyId; ?>" 
                               style="color:#6366f1; text-decoration:none; font-size:0.9rem;">
                                üí¨ Commenter
                            </a>
                            <a href="/ablelink/stories/edit/<?php echo $storyId; ?>" 
                               style="color:#f59e0b; text-decoration:none; font-size:0.9rem;">
                                ‚úèÔ∏è Modifier
                            </a>
                            <a href="/ablelink/stories/delete/<?php echo $storyId; ?>" 
                               onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette story ?');"
                               style="color:#ef4444; text-decoration:none; font-size:0.9rem;">
                                üóëÔ∏è Supprimer
                            </a>
                        </div>
                        <a href="/ablelink/stories/show/<?php echo $storyId; ?>" 
                           style="background:#6366f1; color:white; padding:8px 15px; border-radius:6px; text-decoration:none; font-size:0.9rem;">
                            Lire la suite
                        </a>
                    </div>
                </div>
            </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
</div>

<script>
function likeStory(id) {
    if(!id || id === 0) {
        alert('ID invalide');
        return;
    }
    var url = '/ablelink/stories/like/' + id;
    fetch(url, {method: 'POST'})
        .then(function(response) { 
            if(!response.ok) {
                throw new Error('Erreur r√©seau');
            }
            return response.json(); 
        })
        .then(function(data) {
            if(data && data.success) {
                var selector = '.likes-count-' + id;
                var countElement = document.querySelector(selector);
                var buttonSelector = '[data-story-id="' + id + '"]';
                var buttonElement = document.querySelector(buttonSelector);
                if(countElement) {
                    countElement.textContent = data.likes || 0;
                }
                if(buttonElement) {
                    buttonElement.style.color = '#ef4444';
                }
            } else {
                var message = 'D√©j√† lik√©';
                if(data && data.message) {
                    message = data.message;
                }
                alert(message);
            }
        })
        .catch(function(error) {
            console.error('Erreur:', error);
            alert('Une erreur est survenue');
        });
}
</script>


